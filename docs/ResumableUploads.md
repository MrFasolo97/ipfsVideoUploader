# Resumable Uploads API

**NOTE: All 3Sepak videos MUST go through 3Speak's centralized API and encoding system as of v3.0 release. There is no other way to get them to play on 3speak.tv website.**

OneLoveIPFS uploader uses [tus](https://tus.io) protocol for resumable video uploads, which handles chunked file uploads over HTTPS. The results of the file upload is stored in an upload register, which may be retrieved over `/uploadStat` Socket IO endpoint.

## Server installation

`tusd` server daemon may be installed by using a script (depending on OS) in the `scripts` folder.

#### macOS:
```
sudo ./scripts/tusd_macos_install.sh
```

#### Ubuntu:
```
sudo ./scripts/tusd_ubuntu_install.sh
```

#### Windows (Powershell as admin):
```
Invoke-WebRequest -o tusd.zip "https://github.com/tus/tusd/releases/download/v1.8.0/tusd_windows_amd64.zip"
Expand-Archive -LiteralPath tusd.zip -DestinationPath tusd
Set-Location tusd/tusd*
Copy-Item tusd.exe C:\Windows\System32
Set-Location ../..
Remove-Item -Recurse tusd
Remove-Item tusd.zip
```

#### To start `tusd`:
```
tusd -upload-dir /dir/to/upload/destination -hooks-http http://localhost:3000/uploadVideoResumable -hooks-enabled-events pre-create,post-finish
```
Replace `/dir/to/upload/destination` with the full path to folder for upload storage, and adjust `http://localhost:3000` accordingly depending on your `config.json` file. Append `-behind-proxy` if running behind reverse proxy (e.g. nginx).

## Hostnames

In production environment, tus upload protocol requires configuring the hostname of the server to be the `tusd` endpoint domain, such as `tusd.oneloveipfs.com`. To do this, run the following:

```
sudo hostnamectl set-hostname tusd.yourdomain.com
```

It is often required to update the configuration files manually. Open the following files and replace the hostnames accordingly:

1. `/etc/hostname`
2. `/etc/hosts`

Then reboot your server.

## Usage

Depending on your client platform, you may find different implementations for tus resumable upload protocol [here](https://tus.io/implementations.html), and Socket IO [here](https://socket.io/docs).

OneLoveIPFS's production `tusd` upload endpoint may be reachable at `https://tusd.oneloveipfs.com/files`.

#### Upload JSON metadata:
* `type` *(required)*: Upload type. Valid values: `videos`, `video240`, `video480`, `video720` and `video1080`.
* `createSprite` *(optional, hls type only)*: Whether to generate video sprites, provided that sprite generation is enabled on server.
* `skynet` *(optional)*: Whether to upload file to Skynet, provided that Skynet is enabled on server.
* `selfEncode` *(optional, hlsencode type only)*: Specify if upload is an output of self-encode. For more details and metadata, please read the doc on [self-encode](https://github.com/oneloveipfs/ipfsVideoUploader/blob/master/docs/SelfEncode.md).

#### Obtaining upload results

As `tusd` calls `onSuccess()` on the client right after when an upload is complete and before the `post-upload` webhook is called to process the upload, it is neccessary by design, to register the upload ID with the Socket IO endpoint in order to receive your upload results. This is also needed to be able to receive upload processing progress events.

Upload ID registration may be done by emitting `registerid` to the `/uploadStat` endpoint with the following data (all values are in strings):

* `id` *(required)*: Resulting upload ID of the upload
* `type` *(required)*: Upload type, should be the same as the upload type specified in the upload JSON metadata. Valid values: `hls`, `hlsencode`, `videos`, `video240`, `video480`, `video720` and `video1080`.
* `access_token` *(required)*: Access token obtained in `/logincb` POST API or SteemConnect access token. Should be the same as the access token specified in the upload JSON metadata. Must be generated by an admin account (or defined encoder accounts) if uploaded from encoding servers.
* `keychain` *(optional)*: Set this to "true" (in string) if access token is obtained from `/logincb` POST API. Should be the same as the `keychain` value specified in the upload JSON metadata.

## Schematics

![Resumable Upload Schematics.png](https://video.oneloveipfs.com/ipfs/QmUGZtd9aEEdadRUdXTqhDvrer3hUMptdVsVH8ybEGbQCi)

## Javascript example

HTML:
```html
<script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.0/socket.io.js"></script>
```

Javascript:
```js
// Socket IO connection for upload results
let uplStat = io.connect('/uploadStat')

// Begin event for HLS video upload processing. Emitted at the start of a processing step (e.g. begin encoding).
uplStat.on('begin',(s) => {
    console.log(s)
})

// Progress event for HLS video upload processing (FFmpeg encoding and IPFS add)
uplStat.on('progress',(p) => {
    console.log(p)
})

// Listen for upload results
uplStat.on('result',(r) => {
    console.log(r)
})

// tus resumable file upload
let videoToUpload = document.getElementById('fileInput').files[0]
let videoUpload = new tus.Upload(videoToUpload[0], {
    endpoint: 'https://tusd.oneloveipfs.com/files',
    retryDelays: [0,3000,5000,10000,20000],
    parallelUploads: 10, // number of upload threads
    metadata: {
        access_token: 'your access token here',
        keychain: 'true',
        type: 'videos'
    },
    onError: (e) => {
        console.log('tus error',e)
    },
    onProgress: (bu,bt) => {
        let progressPercent = Math.round((bu / bt) * 100)
        console.log('Progress: ' + progressPercent + '%')
    },
    onSuccess: () => {
        let url = videoUpload.url.toString().split('/')
        console.log("Upload ID: " + url[url.length - 1]) // ID of upload
        uplStat.emit('registerid',{
            id: url[url.length - 1],
            type: 'videos',
            access_token: 'your access token here',
            keychain: 'true'
        })
    }
})

videoUpload.findPreviousUploads().then((p) => {
    if (p.length > 0)
        videoUpload.resumeFromPreviousUpload(p[0])
    videoUpload.start()
})
```

#### Result example:

For `videos` upload type:
```json
{
    "username": "techcoderx",
    "network": "all",
    "type": "videos",
    "ipfshash": "QmXEVRMFWJtGodYdcQQ5EEVJE7VTsq4rPcoBet4KLonF1r",
    "spritehash": "QmTfsUT6aS2QXUoA9CSgTF9Lp4sFruRix29RjxznkQVCv1",
    "duration": 666.967,
    "filesize": 553986721
}
```

For `hls` upload type:
```json
{
    "username": "randomvlogs",
    "network": "hive",
    "type": "hls",
    "ipfshash": "Qmc1jNJLWCTguN6v6qeaeVR8upRKwSurnUStyRWTk2GV6Y",
    "size": 2314353,
    "duration": 6.515,
    "hasThumbnail": true,
    "resolutions": [720,1080]
}
```

Other than the above upload types:
```json
{
    "username": "techcoderx",
    "network": "all",
    "type": "video720",
    "hash": "QmSGEj3j7i1YJtYmuAEKzNaKhifDiB41fdiDHjAeGSpMGe"
}
```
